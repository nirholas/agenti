<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free Crypto News - Failsafe Mirror</title>
  <meta name="description" content="Backup mirror for Free Crypto News API - 100% free crypto news aggregator">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>">
  <style>
    :root {
      --bg: #0a0a0a;
      --card-bg: #141414;
      --border: #262626;
      --text: #fafafa;
      --text-muted: #a1a1a1;
      --accent: #f7931a;
      --green: #22c55e;
      --red: #ef4444;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    h1 span {
      color: var(--accent);
    }
    
    .subtitle {
      color: var(--text-muted);
      font-size: 1.1rem;
    }
    
    .status-banner {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-dot.online { background: var(--green); }
    .status-dot.offline { background: var(--red); }
    .status-dot.checking { background: var(--accent); }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    select, input, button {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    button {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .news-grid {
      display: grid;
      gap: 1.5rem;
    }
    
    .news-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: border-color 0.2s;
    }
    
    .news-card:hover {
      border-color: var(--accent);
    }
    
    .news-card h3 {
      font-size: 1.2rem;
      margin-bottom: 0.75rem;
    }
    
    .news-card h3 a {
      color: var(--text);
      text-decoration: none;
    }
    
    .news-card h3 a:hover {
      color: var(--accent);
    }
    
    .news-meta {
      display: flex;
      gap: 1rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .news-source {
      color: var(--accent);
      font-weight: 500;
    }
    
    .news-description {
      color: var(--text-muted);
      margin-top: 0.75rem;
      font-size: 0.95rem;
    }
    
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    
    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--red);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      color: var(--red);
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .api-endpoints {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 2rem;
    }
    
    .api-endpoints h3 {
      margin-bottom: 1rem;
      color: var(--accent);
    }
    
    .endpoint-list {
      display: grid;
      gap: 0.5rem;
    }
    
    .endpoint {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .endpoint-method {
      background: var(--green);
      color: #000;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    footer {
      text-align: center;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
    }
    
    footer a {
      color: var(--accent);
      text-decoration: none;
    }
    
    .cache-info {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üì∞ Free <span>Crypto</span> News</h1>
      <p class="subtitle">Failsafe Mirror - Static Backup When Main API is Down</p>
    </header>
    
    <div class="status-banner">
      <div class="status-item">
        <span class="status-dot checking" id="main-status"></span>
        <span>Main API: <strong id="main-status-text">Checking...</strong></span>
      </div>
      <div class="status-item">
        <span class="status-dot online"></span>
        <span>Failsafe: <strong>Online</strong></span>
      </div>
      <div class="cache-info">
        Last updated: <span id="cache-time">Loading...</span>
      </div>
    </div>
    
    <div class="controls">
      <select id="category">
        <option value="all">All News</option>
        <option value="bitcoin">Bitcoin</option>
        <option value="defi">DeFi</option>
        <option value="breaking">Breaking</option>
      </select>
      <input type="text" id="search" placeholder="Search news...">
      <button onclick="loadNews()">üîç Search</button>
      <button onclick="refreshFromMain()" id="refresh-btn">üîÑ Try Main API</button>
    </div>
    
    <div id="news-container" class="news-grid">
      <div class="loading">Loading cached news...</div>
    </div>
    
    <div class="pagination" id="pagination"></div>
    
    <div class="api-endpoints">
      <h3>üì° Static JSON Endpoints (Always Available)</h3>
      <div class="endpoint-list">
        <div class="endpoint">
          <span class="endpoint-method">GET</span>
          <span>/cache/latest.json - Latest news (updated hourly)</span>
        </div>
        <div class="endpoint">
          <span class="endpoint-method">GET</span>
          <span>/cache/bitcoin.json - Bitcoin-specific news</span>
        </div>
        <div class="endpoint">
          <span class="endpoint-method">GET</span>
          <span>/cache/defi.json - DeFi news</span>
        </div>
        <div class="endpoint">
          <span class="endpoint-method">GET</span>
          <span>/cache/trending.json - Trending topics</span>
        </div>
        <div class="endpoint">
          <span class="endpoint-method">GET</span>
          <span>/cache/sources.json - All sources</span>
        </div>
        <div class="endpoint">
          <span class="endpoint-method">GET</span>
          <span>/archive/index.json - Archive index</span>
        </div>
      </div>
    </div>
    
    <footer>
      <p>
        Main API: <a href="https://free-crypto-news.vercel.app" target="_blank">free-crypto-news.vercel.app</a> |
        GitHub: <a href="https://github.com/nirholas/free-crypto-news" target="_blank">nirholas/free-crypto-news</a>
      </p>
      <p style="margin-top: 0.5rem;">
        100% Free ‚Ä¢ No API Keys ‚Ä¢ No Rate Limits
      </p>
    </footer>
  </div>
  
  <script>
    const MAIN_API = 'https://free-crypto-news.vercel.app';
    const FAILSAFE_BASE = window.location.origin;
    
    let currentPage = 0;
    let useMainApi = false;
    let cachedData = null;
    
    // Check main API status
    async function checkMainApi() {
      const statusDot = document.getElementById('main-status');
      const statusText = document.getElementById('main-status-text');
      
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${MAIN_API}/api/health`, {
          signal: controller.signal
        });
        clearTimeout(timeout);
        
        if (response.ok) {
          statusDot.className = 'status-dot online';
          statusText.textContent = 'Online';
          useMainApi = true;
          document.getElementById('refresh-btn').textContent = '‚úì Using Main API';
        } else {
          throw new Error('Not OK');
        }
      } catch {
        statusDot.className = 'status-dot offline';
        statusText.textContent = 'Offline - Using Failsafe';
        useMainApi = false;
      }
    }
    
    // Load news from appropriate source
    async function loadNews() {
      const container = document.getElementById('news-container');
      const category = document.getElementById('category').value;
      const search = document.getElementById('search').value;
      
      container.innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        let data;
        
        if (useMainApi) {
          // Use main API
          let url = `${MAIN_API}/api/news?limit=20`;
          if (category !== 'all') {
            url = `${MAIN_API}/api/${category}?limit=20`;
          }
          if (search) {
            url = `${MAIN_API}/api/search?q=${encodeURIComponent(search)}&limit=20`;
          }
          
          const response = await fetch(url);
          data = await response.json();
        } else {
          // Use cached static files
          const cacheFile = category === 'all' ? 'latest' : category;
          const response = await fetch(`${FAILSAFE_BASE}/cache/${cacheFile}.json`);
          
          if (!response.ok) {
            throw new Error('Cache not available');
          }
          
          data = await response.json();
          
          // Client-side search filter
          if (search && data.articles) {
            const searchLower = search.toLowerCase();
            data.articles = data.articles.filter(a => 
              a.title.toLowerCase().includes(searchLower) ||
              (a.description && a.description.toLowerCase().includes(searchLower))
            );
          }
          
          // Update cache time
          if (data.cachedAt) {
            document.getElementById('cache-time').textContent = 
              new Date(data.cachedAt).toLocaleString();
          }
        }
        
        cachedData = data;
        renderNews(data.articles || []);
        
      } catch (error) {
        // Build error UI safely without interpreting error.message as HTML
        container.innerHTML = '';

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';

        const titleP = document.createElement('p');
        titleP.textContent = '‚ö†Ô∏è Unable to load news';
        errorDiv.appendChild(titleP);

        const detailP = document.createElement('p');
        detailP.style.marginTop = '0.5rem';
        detailP.style.fontSize = '0.9rem';
        // Use textContent so any characters in error.message are treated as text, not HTML
        detailP.textContent = (error && error.message ? error.message : 'An unexpected error occurred') +
          '. Try refreshing or check back later.';
        errorDiv.appendChild(detailP);

        container.appendChild(errorDiv);
      }
    }
    
    // Render news articles
    function renderNews(articles) {
      const container = document.getElementById('news-container');
      
      if (!articles.length) {
        container.innerHTML = '<div class="loading">No articles found</div>';
        return;
      }
      
      container.innerHTML = articles.map(article => `
        <div class="news-card">
          <h3><a href="${article.link}" target="_blank" rel="noopener">${escapeHtml(article.title)}</a></h3>
          <div class="news-meta">
            <span class="news-source">${escapeHtml(article.source)}</span>
            <span>${formatDate(article.pubDate)}</span>
          </div>
          ${article.description ? `<p class="news-description">${escapeHtml(truncate(article.description, 200))}</p>` : ''}
        </div>
      `).join('');
    }
    
    // Try to refresh from main API
    async function refreshFromMain() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.textContent = 'Checking...';
      
      await checkMainApi();
      
      if (useMainApi) {
        loadNews();
      }
      
      btn.disabled = false;
    }
    
    // Utility functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function truncate(text, length) {
      if (!text || text.length <= length) return text;
      return text.substring(0, length) + '...';
    }
    
    function formatDate(dateStr) {
      try {
        const date = new Date(dateStr);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
        
        return date.toLocaleDateString();
      } catch {
        return dateStr;
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await checkMainApi();
      loadNews();
    });
    
    // Search on Enter
    document.getElementById('search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadNews();
    });
  </script>
</body>
</html>
