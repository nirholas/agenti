name: Daily Discovery

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to look back'
        required: false
        default: '1'
      submit:
        description: 'Submit to registry'
        required: false
        default: 'false'
      dry_run:
        description: 'Dry run mode'
        required: false
        default: 'true'

permissions:
  contents: read

jobs:
  discover:
    name: Discover MCP Crypto Tools
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[ai]"
      
      - name: Run Discovery Pipeline
        id: discovery
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LYRA_REGISTRY_URL: ${{ secrets.LYRA_REGISTRY_URL }}
          LYRA_REGISTRY_API_KEY: ${{ secrets.LYRA_REGISTRY_API_KEY }}
        run: |
          python scripts/daily_discovery.py \
            --days-back ${{ github.event.inputs.days_back || '1' }} \
            ${{ github.event.inputs.submit == 'true' && '--submit' || '' }} \
            ${{ github.event.inputs.dry_run == 'false' && '--no-dry-run' || '--dry-run' }}
      
      - name: Upload Discovery Results
        uses: actions/upload-artifact@v4
        with:
          name: discovery-results-${{ github.run_id }}
          path: discovery_results/
          retention-days: 30
      
      - name: Create Summary
        run: |
          echo "## ðŸ” Daily Discovery Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repos Discovered | ${{ steps.discovery.outputs.repos_discovered || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tools Found | ${{ steps.discovery.outputs.tools_found || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tools Accepted | ${{ steps.discovery.outputs.tools_accepted || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${{ steps.discovery.outputs.duration || 'N/A' }}s |" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Significant Discoveries
    runs-on: ubuntu-latest
    needs: discover
    if: ${{ needs.discover.outputs.tools_accepted > 0 }}
    
    steps:
      - name: Send Notification
        run: |
          echo "ðŸŽ‰ New tools discovered and accepted!"
          echo "Tools accepted: ${{ needs.discover.outputs.tools_accepted }}"
          # Add webhook/Slack notification here if needed
